<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>DA Tooltitle>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script type="text/javascript">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "tg5m3upt4f");
</script>
<style>
body { font-family: Arial; margin:0; padding:0; background:#e0f7ff; color:#003366; }
header { background:#0099cc; color:white; padding:20px; text-align:center; box-shadow:0 4px 6px rgba(0,0,0,0.1); }
main { padding:20px; max-width:1200px; margin:auto; }
.section { background:#fff; padding:20px; border-radius:12px; margin-bottom:20px; box-shadow:0 4px 6px rgba(0,0,0,0.05);}
h2 { color:#006699; }
.controls { display:flex; flex-wrap:wrap; gap:20px; align-items:flex-end; }
label { font-weight:bold; display:block; margin-bottom:5px; }
input[type=number], input[type=range] { padding:5px; }
.toggle { margin-right:10px; }
.dropzone { position: relative; border:2px dashed #0099cc; border-radius:12px; padding:30px; text-align:center; color:#006699; font-weight:bold; cursor:pointer; transition:background-color 0.2s;}
.dropzone.hover { background-color:#ccf0ff; }
#summary, #peaks, #bursts { margin-top:10px; }
#graph { width:100%; height:500px; margin-top:20px; }
button { background:#0099cc; color:white; border:none; padding:8px 16px; border-radius:8px; cursor:pointer; transition:0.2s; margin:5px 0;}
button:hover { background:#0077aa; }
table { border-collapse: collapse; width:100%; margin-top:10px;}
th, td { border:1px solid #ccc; padding:6px; text-align:center;}
th { background:#0099cc; color:white; }
</style>
</head>
<body>
<header>
<h1>EMG + ROM Tool</h1>
</header>
<main>
<div class="section">
<h2>Upload Data</h2>
<div class="controls">
<div class="dropzone" id="emgDrop">Drag & Drop EMG File or Click</div>
<button onclick="clearFile('emg')">Clear EMG</button>
<div class="dropzone" id="romDrop">Drag & Drop ROM File or Click</div>
<button onclick="clearFile('rom')">Clear ROM</button>
<button onclick="generateGraph()">Generate Graph</button>
</div>
</div>
<div class="section">
<h2>Interactive Graph</h2>
<div id="graph"></div>
</div>
<div class="section">
<h2>Options</h2>
<div class="controls">
<div>
<label>RMS Window (samples)</label>
<input type="number" id="envWindow" value="50" min="1">
</div>
<div>
<label>Burst Threshold Multiplier: <span id="threshVal">1.5</span></label>
<input type="range" id="threshMult" value="1.5" min="0.1" max="5" step="0.1" oninput="document.getElementById('threshVal').innerText=this.value">
</div>
<div>
<label>Toggles</label><br>
<input type="checkbox" id="showEMG" class="toggle" checked> Show EMG<br>
<input type="checkbox" id="showEnv" class="toggle"> Show RMS Envelope<br>
<input type="checkbox" id="showBursts" class="toggle" checked> Show Bursts<br>
<input type="checkbox" id="showROM" class="toggle" checked> Show ROM
</div>
<div>
<button onclick="copyGraphData()">Copy Data to Clipboard</button>
</div>
</div>
</div>
<div class="section">
<h2>Summary</h2>
<div id="summary"></div>
<button onclick="downloadCSV('summary')">Download Summary CSV</button>
</div>
<div class="section">
<h2>Top 3 EMG Peaks</h2>
<div id="peaks"></div>
</div>
<div class="section">
<h2>Burst Information</h2>
<div id="bursts"></div>
<button onclick="downloadCSV('bursts')">Download Bursts CSV</button>
</div>
</main>
<script>
const fs = 50;
let emgVals = [], romVals = [];
let burstData = [], summaryData = [], burstRects = [];
function parseData(text){ return text.replace(/\n/g,',').replace(/\s/g,',').split(',').map(x=>parseFloat(x)).filter(x=>!isNaN(x)); }
function calcRMS(values,window){ return values.map((v,i)=>{ const start=Math.max(0,i-window+1); const sumSq=values.slice(start,i+1).reduce((a,b)=>a+b**2,0); return Math.sqrt(sumSq/(i-start+1)); }); }
function detectBursts(rms,mult){
    const mean=rms.reduce((a,b)=>a+b,0)/rms.length;
    const std=Math.sqrt(rms.reduce((a,b)=>a+(b-mean)**2,0)/rms.length);
    const thresh=mean+mult*std;
    const bursts=[]; let inBurst=false,start=0;
    rms.forEach((v,i)=>{ if(v>thresh && !inBurst){start=i; inBurst=true;} else if(v<=thresh && inBurst){bursts.push([start,i-1]); inBurst=false;} });
    if(inBurst) bursts.push([start,rms.length-1]);
    return {bursts,thresh};
}
function topPeaks(values,n=3){ return [...values].map((v,i)=>({val:v,idx:i})).sort((a,b)=>b.val-a.val).slice(0,n); }
function setupDropzone(id,callback){
    const dz = document.getElementById(id);
    dz.addEventListener('click', ()=>{
        const input=document.createElement('input');
        input.type='file'; input.accept='.txt';
        input.onchange=e=>callback(e.target.files[0]);
        input.click();
    });
    dz.addEventListener('dragover', e=>{ e.preventDefault(); dz.classList.add('hover'); });
    dz.addEventListener('dragleave', e=>{ dz.classList.remove('hover'); });
    dz.addEventListener('drop', e=>{
        e.preventDefault(); dz.classList.remove('hover');
        if(e.dataTransfer.files.length>0) callback(e.dataTransfer.files[0]);
    });
}
setupDropzone('emgDrop', file=>{
    const reader=new FileReader();
    reader.onload=e=>{ emgVals=parseData(e.target.result); document.getElementById('emgDrop').textContent=file.name; };
    reader.readAsText(file);
});
setupDropzone('romDrop', file=>{
    const reader=new FileReader();
    reader.onload=e=>{ romVals=parseData(e.target.result); document.getElementById('romDrop').textContent=file.name; };
    reader.readAsText(file);
});
function clearFile(type){ if(type==='emg'){ emgVals=[]; document.getElementById('emgDrop').textContent='Drag & Drop EMG File or Click'; } if(type==='rom'){ romVals=[]; document.getElementById('romDrop').textContent='Drag & Drop ROM File or Click'; } }
function downloadCSV(type){
    let rows=[];
    if(type==='summary') rows=summaryData;
    if(type==='bursts') rows=burstData;
    let csv=rows.map(r=>Object.values(r).join(",")).join("\n");
    let blob=new Blob([csv],{type:"text/csv"});
    let a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download=type+".csv"; a.click();
}
function copyGraphData(){
    let n=Math.max(emgVals.length,romVals.length);
    let time=Array.from({length:n},(_,i)=>i/fs);
    let csv="Time,EMG,ROM\n";
    for(let i=0;i<n;i++){ csv+=`${time[i]},${emgVals[i]||""},${romVals[i]||""}\n`; }
    navigator.clipboard.writeText(csv).then(()=>alert("Graph data copied. Paste into Excel."));
}
function generateGraph(){
    const envWindow=parseInt(document.getElementById('envWindow').value);
    const threshMult=parseFloat(document.getElementById('threshMult').value);
    const showEMG=document.getElementById('showEMG').checked;
    const showEnv=document.getElementById('showEnv').checked;
    const showBursts=document.getElementById('showBursts').checked;
    const showROM=document.getElementById('showROM').checked;
    const n=Math.max(emgVals.length,romVals.length);
    const time=Array.from({length:n},(_,i)=>i/fs);
    const traces=[]; summaryData=[]; burstData=[]; burstRects=[];
    if(emgVals.length>0 && showEMG){
        traces.push({x:time.slice(0,emgVals.length), y:emgVals, mode:'lines', name:'EMG', line:{color:'blue'}});
        const rmsEnv=calcRMS(emgVals,envWindow);
        let bursts=[],thresh=0;
        if(showEnv){
            traces.push({x:time.slice(0,rmsEnv.length), y:rmsEnv, mode:'lines', name:'RMS Envelope', line:{color:'orange'}});
            const res=detectBursts(rmsEnv,threshMult); bursts=res.bursts; thresh=res.thresh;
            if(showBursts){
                traces.push({x:[time[0],time[emgVals.length-1]], y:[thresh,thresh], mode:'lines', name:'Threshold', line:{color:'red', dash:'dash'}});
                bursts.forEach((b,i)=>{
                    burstRects.push({type:"rect", x0:time[b[0]], x1:time[b[1]], y0:0, y1:1, xref:"x", yref:"paper", fillcolor:"red", opacity:0.2, line:{width:0}});
                    burstData.push({Start_s:(b[0]/fs).toFixed(2), End_s:(b[1]/fs).toFixed(2), Duration_s:((b[1]-b[0])/fs).toFixed(2)});
                });
            }
        }
        const emgMin=Math.min(...emgVals), emgMax=Math.max(...emgVals), emgMean=emgVals.reduce((a,b)=>a+b,0)/emgVals.length, emgMedian=[...emgVals].sort((a,b)=>a-b)[Math.floor(emgVals.length/2)], emgStd=Math.sqrt(emgVals.reduce((a,b)=>a+(b-emgMean)**2,0)/emgVals.length), emgRMS=Math.sqrt(emgVals.reduce((a,b)=>a+b*b,0)/emgVals.length);
        summaryData.push({Metric:"EMG Min",Value:emgMin.toFixed(2)});
        summaryData.push({Metric:"EMG Max (Abs Peak)",Value:emgMax.toFixed(2)});
        summaryData.push({Metric:"EMG Mean",Value:emgMean.toFixed(2)});
        summaryData.push({Metric:"EMG Median",Value:emgMedian.toFixed(2)});
        summaryData.push({Metric:"EMG Std",Value:emgStd.toFixed(2)});
        summaryData.push({Metric:"EMG RMS",Value:emgRMS.toFixed(2)});
        summaryData.push({Metric:"Bursts Detected",Value:bursts.length});
        const peaks=topPeaks(emgVals,3);
        let peakTable="<table><tr><th>#</th><th>Value</th><th>Time (s)</th></tr>";
        peaks.forEach((p,i)=>{ peakTable+=`<tr><td>${i+1}</td><td>${p.val.toFixed(2)}</td><td>${(p.idx/fs).toFixed(2)}</td></tr>`; traces.push({x:[time[p.idx]], y:[p.val], mode:'markers+text', text:['P'+(i+1)], textposition:'top center', marker:{color:'green', size:10}}); });
        peakTable+="</table>";
        document.getElementById('peaks').innerHTML=peakTable;
    }
    if(romVals.length>0 && showROM){
        traces.push({x:time.slice(0,romVals.length), y:romVals, mode:'lines', name:'ROM', line:{color:'purple'}, yaxis:"y2"});
        const romMin=Math.min(...romVals), romMax=Math.max(...romVals), romMean=romVals.reduce((a,b)=>a+b,0)/romVals.length, romMedian=[...romVals].sort((a,b)=>a-b)[Math.floor(romVals.length/2)], romStd=Math.sqrt(romVals.reduce((a,b)=>a+(b-romMean)**2,0)/romVals.length);
        summaryData.push({Metric:"ROM Min",Value:romMin.toFixed(2)});
        summaryData.push({Metric:"ROM Max",Value:romMax.toFixed(2)});
        summaryData.push({Metric:"ROM Mean",Value:romMean.toFixed(2)});
        summaryData.push({Metric:"ROM Median",Value:romMedian.toFixed(2)});
        summaryData.push({Metric:"ROM Std",Value:romStd.toFixed(2)});
    }
    let summaryTable="<table><tr><th>Metric</th><th>Value</th></tr>";
    summaryData.forEach(r=>summaryTable+=`<tr><td>${r.Metric}</td><td>${r.Value}</td></tr>`);
    summaryTable+="</table>";
    document.getElementById('summary').innerHTML=summaryTable;
    if(burstData.length>0){
        let burstTable="<table><tr><th>#</th><th>Start (s)</th><th>End (s)</th><th>Duration (s)</th></tr>";
        burstData.forEach((b,i)=>{ burstTable+=`<tr><td>${i+1}</td><td>${b.Start_s}</td><td>${b.End_s}</td><td>${b.Duration_s}</td></tr>`; });
        burstTable+="</table>";
        document.getElementById('bursts').innerHTML=burstTable;
    } else {
        document.getElementById('bursts').innerHTML="<i>No bursts detected or envelope disabled</i>";
    }
    const layout={
        title:'EMG + ROM Dashboard',
        xaxis:{title:'Time (s)'},
        yaxis:{title:'EMG'},
        hovermode:'x unified',
        shapes:burstRects
    };
    if(showROM && romVals.length>0) layout.yaxis2={title:'ROM', overlaying:'y', side:'right'};
    Plotly.newPlot('graph',traces,layout,{responsive:true,displaylogo:false,modeBarButtonsToAdd:["toImage"]});
}
</script>
</body>
</html>
